<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ProviderV Player</title>

    <!-- Video.js CSS -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
      }

      .header h1 {
        font-size: 3rem;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2rem;
        opacity: 0.9;
      }

      .tabs {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 30px;
      }

      .tab {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        cursor: pointer;
        border-radius: 8px;
        transition: background 0.3s;
      }

      .tab.active {
        background: rgba(255, 255, 255, 0.2);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .input-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .input-section h2 {
        margin-top: 0;
        color: #fff;
        font-size: 24px;
        margin-bottom: 10px;
      }

      .input-section p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 20px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: rgba(255, 255, 255, 0.9);
      }

      .input-group input {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.9);
        font-size: 16px;
        margin-bottom: 10px;
      }

      .primary-btn {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: transform 0.2s;
      }

      .primary-btn:hover {
        transform: scale(1.05);
      }

      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        margin: 15px 0;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-top: 3px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .provider-switcher {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }

      .provider-switcher select {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
      }

      .provider-badge {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: bold;
      }

      #videoPlayerSection {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 25px;
        margin: 20px 0;
        backdrop-filter: blur(10px);
      }

      .player-controls {
        margin-bottom: 20px;
      }

      .player-controls h3 {
        color: #fff;
        margin-bottom: 15px;
        font-size: 20px;
      }

      .video-player-container {
        border-radius: 10px;
        overflow: hidden;
        background: #000;
        position: relative;
      }

      /* Force Video.js styling */
      .video-js {
        width: 100% !important;
        height: 450px !important;
        max-width: 100% !important;
      }

      .video-js .vjs-control-bar {
        background: rgba(43, 51, 63, 0.7) !important;
        backdrop-filter: blur(10px);
      }

      .video-js .vjs-big-play-button {
        background: rgba(43, 51, 63, 0.8) !important;
        border: 2px solid #fff !important;
        border-radius: 50% !important;
        width: 80px !important;
        height: 80px !important;
        line-height: 76px !important;
        margin-top: -40px !important;
        margin-left: -40px !important;
      }

      .video-js .vjs-big-play-button:hover {
        background: rgba(43, 51, 63, 1) !important;
      }

      .error {
        background: linear-gradient(135deg, #e74c3c, #c0392b);
        color: white;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        text-align: center;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header h1 {
          font-size: 2rem;
        }

        .tabs {
          flex-direction: column;
        }

        .tab {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸŽ¬ ProviderV Player</h1>
        <p>Stream movies and TV shows with automatic provider detection</p>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('movies', event)">ðŸŽ¥ Movies</button>
        <button class="tab" onclick="switchTab('tv', event)">ðŸ“º TV Shows</button>
      </div>

      <!-- Movies Tab -->
      <div id="moviesTab" class="tab-content active">
        <div class="input-section">
          <h2>ðŸŽ¥ Movies</h2>
          <p>Enter a TMDB ID to automatically find and play streams</p>
          <div class="input-group">
            <label for="movieTmdbId">TMDB ID:</label>
            <input
              type="number"
              id="movieTmdbId"
              placeholder="e.g., 550 (Fight Club)"
              onkeypress="handleEnterKey(event, 'movie')"
            />
            <button onclick="loadMovie()" class="primary-btn">ðŸŽ¬ Play Movie</button>
          </div>
          <div id="movieLoading" class="loading" style="display: none">
            <div class="spinner"></div>
            <span>Finding streams automatically...</span>
          </div>
        </div>
      </div>

      <!-- TV Shows Tab -->
      <div id="tvTab" class="tab-content">
        <div class="input-section">
          <h2>ðŸ“º TV Shows</h2>
          <p>Enter TMDB ID, season, and episode to automatically find and play streams</p>
          <div class="input-group">
            <label for="tvTmdbId">TMDB ID:</label>
            <input
              type="number"
              id="tvTmdbId"
              placeholder="e.g., 1399 (Game of Thrones)"
              onkeypress="handleEnterKey(event, 'tv')"
            />
          </div>
          <div class="input-group">
            <label for="tvSeason">Season:</label>
            <input type="number" id="tvSeason" placeholder="e.g., 1" min="1" onkeypress="handleEnterKey(event, 'tv')" />
          </div>
          <div class="input-group">
            <label for="tvEpisode">Episode:</label>
            <input
              type="number"
              id="tvEpisode"
              placeholder="e.g., 1"
              min="1"
              onkeypress="handleEnterKey(event, 'tv')"
            />
          </div>
          <div class="input-group">
            <button onclick="loadTVShow()" class="primary-btn">ðŸ“º Play Episode</button>
          </div>
          <div id="tvLoading" class="loading" style="display: none">
            <div class="spinner"></div>
            <span>Finding streams automatically...</span>
          </div>
        </div>
      </div>

      <!-- Video Player Section -->
      <div id="videoPlayerSection" style="display: none">
        <div class="player-controls">
          <h3 id="currentTitle">Now Playing</h3>
          <div class="provider-switcher">
            <label for="providerSelect">Switch Provider:</label>
            <select id="providerSelect" onchange="switchProvider()">
              <option value="">Current provider working...</option>
            </select>
            <span id="currentProvider" class="provider-badge"></span>
          </div>
        </div>
        <div class="video-player-container">
          <video id="videoPlayer" class="video-js vjs-default-skin" controls preload="auto" data-setup="{}">
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider upgrading to a web browser that
              <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
            </p>
          </video>
        </div>
      </div>

      <div id="error" class="error" style="display: none"></div>
    </div>

    <!-- Video.js JavaScript -->
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
    <!-- HLS support -->
    <script src="https://cdn.jsdelivr.net/npm/@videojs/http-streaming@3.9.0/dist/videojs-http-streaming.min.js"></script>

    <script>
      // Debug: Check if Video.js loaded
      console.log('Video.js version:', typeof videojs !== 'undefined' ? videojs.VERSION : 'NOT LOADED');

      // Wait for page to load
      document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM loaded, Video.js available:', typeof videojs !== 'undefined');
      });
      function switchTab(tabName, event) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach((content) => {
          content.classList.remove('active');
        });

        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach((tab) => {
          tab.classList.remove('active');
        });

        // Show selected tab content
        document.getElementById(tabName + 'Tab').classList.add('active');

        // Add active class to selected tab (if called from button click)
        if (event && event.target) {
          event.target.classList.add('active');
        } else {
          // If called programmatically, find and activate the correct tab
          const tabs = document.querySelectorAll('.tab');
          tabs.forEach((tab, index) => {
            if ((tabName === 'movies' && index === 0) || (tabName === 'tv' && index === 1)) {
              tab.classList.add('active');
            }
          });
        }
      }

      function handleEnterKey(event, type) {
        if (event.key === 'Enter') {
          if (type === 'movie') {
            loadMovie();
          } else if (type === 'tv') {
            loadTVShow();
          }
        }
      }

      async function loadMovie() {
        const tmdbId = document.getElementById('movieTmdbId').value;
        if (!tmdbId) {
          showError('Please enter a TMDB ID');
          return;
        }

        showLoading('movie', true);
        hideError();

        try {
          const response = await fetch(`http://localhost:3001/api/v1/movie/${tmdbId}`);
          const data = await response.json();

          if (data.error) {
            showError('Movie loading error: ' + data.error);
            showLoading('movie', false);
            return;
          }

          if (!data.streams || data.streams.length === 0) {
            showError('No streams found for this movie');
            showLoading('movie', false);
            return;
          }

          // Set current title and provider info
          document.getElementById('currentTitle').textContent =
            `${data.title || 'Movie'} (${data.year || 'Unknown Year'})`;
          document.getElementById('currentProvider').textContent = data.streams[0].providerId;

          // Populate provider switcher
          populateProviderSwitcher(data.streams);

          // Store streams globally
          window.currentStreams = data.streams;
          window.currentContent = { tmdbId, type: 'movie' };

          // Play the first available stream
          playStream(data.streams[0]);

          showLoading('movie', false);
          showPlayer();
        } catch (error) {
          showError('Movie loading failed: ' + error.message);
          showLoading('movie', false);
        }
      }

      async function loadTVShow() {
        const tmdbId = document.getElementById('tvTmdbId').value;
        const season = document.getElementById('tvSeason').value;
        const episode = document.getElementById('tvEpisode').value;

        if (!tmdbId || !season || !episode) {
          showError('Please enter TMDB ID, season, and episode');
          return;
        }

        showLoading('tv', true);
        hideError();

        try {
          const response = await fetch(`http://localhost:3001/api/v1/tv/${tmdbId}/${season}/${episode}`);
          const data = await response.json();

          if (data.error) {
            showError('TV show loading error: ' + data.error);
            showLoading('tv', false);
            return;
          }

          if (!data.streams || data.streams.length === 0) {
            showError('No streams found for this episode');
            showLoading('tv', false);
            return;
          }

          // Set current title and provider info
          document.getElementById('currentTitle').textContent = `${data.title || 'TV Show'} S${season}E${episode}`;
          document.getElementById('currentProvider').textContent = data.streams[0].providerId;

          // Populate provider switcher
          populateProviderSwitcher(data.streams);

          // Store streams globally
          window.currentStreams = data.streams;
          window.currentContent = { tmdbId, season, episode, type: 'tv' };

          // Play the first available stream
          playStream(data.streams[0]);

          showLoading('tv', false);
          showPlayer();
        } catch (error) {
          showError('TV show loading failed: ' + error.message);
          showLoading('tv', false);
        }
      }

      function populateProviderSwitcher(streams) {
        const select = document.getElementById('providerSelect');
        select.innerHTML = '<option value="">Switch to different provider...</option>';

        streams.forEach((stream, index) => {
          if (index > 0) {
            // Skip first one as it's already playing
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `${stream.providerId} - ${stream.quality || 'Unknown Quality'}`;
            select.appendChild(option);
          }
        });
      }

      function switchProvider() {
        const select = document.getElementById('providerSelect');
        const streamIndex = parseInt(select.value);

        if (isNaN(streamIndex) || !window.currentStreams || !window.currentStreams[streamIndex]) {
          return;
        }

        const stream = window.currentStreams[streamIndex];
        document.getElementById('currentProvider').textContent = stream.providerId;
        playStream(stream);

        // Reset selection
        select.value = '';
      }

      function playStream(stream) {
        console.log('Playing stream:', stream);
        console.log('Stream object details:', JSON.stringify(stream, null, 2));

        // Properly dispose of existing player
        if (window.currentPlayer) {
          try {
            window.currentPlayer.dispose();
            window.currentPlayer = null;
            // Clear the video element
            const videoElement = document.getElementById('videoPlayer');
            if (videoElement) {
              videoElement.innerHTML = `
                <p class="vjs-no-js">
                  To view this video please enable JavaScript, and consider upgrading to a web browser that
                  <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                </p>
              `;
            }
          } catch (e) {
            console.warn('Error disposing player:', e);
          }
        }

        // Extract the actual stream URL from the stream object
        let streamUrl;
        if (typeof stream.stream === 'string') {
          streamUrl = stream.stream;
        } else if (stream.stream && stream.stream.playlist) {
          streamUrl = stream.stream.playlist;
        } else if (stream.stream && stream.stream.file) {
          streamUrl = stream.stream.file;
        } else if (stream.stream && stream.stream.url) {
          streamUrl = stream.stream.url;
        } else {
          console.error('No valid stream URL found in stream object:', stream);
          console.error('Available stream properties:', Object.keys(stream.stream || {}));
          showError('No valid stream URL found in provider response');
          return;
        }

        console.log('Stream URL:', streamUrl);

        // Check if URL looks like a valid stream
        if (!streamUrl || typeof streamUrl !== 'string') {
          showError('Invalid stream URL');
          return;
        }

        // Get required headers from stream object
        const requiredHeaders = stream.stream?.headers || {};
        console.log('Required headers:', requiredHeaders);

        // Handle .txt files which might contain the actual playlist URL
        if (streamUrl.endsWith('.txt')) {
          console.log('Stream URL is a text file, fetching actual playlist URL...');
          try {
            // Build proxy URL with headers for the text file using simple-proxy
            let proxyUrl = `http://localhost:3000/?destination=${encodeURIComponent(streamUrl)}`;

            fetch(proxyUrl)
              .then((response) => response.text())
              .then((textContent) => {
                console.log('Text file content:', textContent);
                // The text file should contain the actual playlist URL
                const actualStreamUrl = textContent.trim();
                if (actualStreamUrl && (actualStreamUrl.includes('.m3u8') || actualStreamUrl.startsWith('http'))) {
                  console.log('Found actual stream URL:', actualStreamUrl);
                  playActualStream(actualStreamUrl, requiredHeaders);
                } else {
                  showError('Text file does not contain a valid stream URL');
                }
              })
              .catch((error) => {
                console.error('Failed to fetch text file:', error);
                showError('Failed to resolve stream URL from text file');
              });
            return; // Exit early for .txt files
          } catch (error) {
            console.error('Error handling .txt file:', error);
            showError('Failed to process stream URL');
            return;
          }
        }

        // For direct stream URLs, proceed normally
        playActualStream(streamUrl, requiredHeaders);
      }

      function playActualStream(streamUrl, headers = {}) {
        console.log('Playing actual stream:', streamUrl, 'with headers:', headers);

        // Determine the content type
        let sourceType = 'application/x-mpegURL'; // Default to HLS
        if (streamUrl.includes('.mp4')) {
          sourceType = 'video/mp4';
        } else if (streamUrl.includes('.m3u8')) {
          sourceType = 'application/x-mpegURL';
        }

        // Define simple-proxy stream function
        const trySimpleProxy = async () => {
          try {
            console.log('Using simple-proxy for HLS streaming...');

            // More thorough cleanup
            if (window.currentPlayer) {
              try {
                console.log('Disposing existing player...');
                window.currentPlayer.dispose();
              } catch (e) {
                console.warn('Error disposing player:', e);
              }
              window.currentPlayer = null;
            }

            // Completely recreate the video element
            const videoContainer = document.querySelector('.video-player-container');
            if (videoContainer) {
              console.log('Recreating video element...');
              videoContainer.innerHTML = `
                <video 
                  id="videoPlayer" 
                  class="video-js vjs-default-skin" 
                  controls 
                  preload="auto" 
                  width="800" 
                  height="450"
                  data-setup='{}'>
                  <p class="vjs-no-js">
                    To view this video please enable JavaScript, and consider upgrading to a web browser that
                    <a href="https://videojs.com/html5-video-support/" target="_blank">supports HTML5 video</a>.
                  </p>
                </video>
              `;
            }

            // Wait for DOM to be ready
            await new Promise((resolve) => setTimeout(resolve, 1000));

            // Check if Video.js is available
            if (typeof videojs === 'undefined') {
              throw new Error('Video.js is not loaded');
            }

            // Check if there's already a player and dispose it properly
            const existingPlayer = videojs.getPlayer('videoPlayer');
            if (existingPlayer) {
              console.log('Disposing existing Video.js player...');
              existingPlayer.dispose();
              await new Promise((resolve) => setTimeout(resolve, 100));
            }

            // Use simple-proxy's m3u8-proxy endpoint for HLS streams
            let proxyUrl;
            if (streamUrl.includes('.m3u8') || sourceType === 'application/x-mpegURL') {
              // Use the specialized HLS proxy endpoint
              proxyUrl = `http://localhost:3000/m3u8-proxy?url=${encodeURIComponent(streamUrl)}`;
              if (headers && Object.keys(headers).length > 0) {
                proxyUrl += `&headers=${encodeURIComponent(JSON.stringify(headers))}`;
              }
            } else {
              // Use general proxy for other types
              proxyUrl = `http://localhost:3000/?destination=${encodeURIComponent(streamUrl)}`;
            }

            console.log('Using simple-proxy URL:', proxyUrl);
            console.log('Initializing Video.js player...');

            window.currentPlayer = videojs('videoPlayer', {
              fluid: true,
              responsive: true,
              controls: true,
              preload: 'auto',
              autoplay: false,
              html5: {
                hls: {
                  enableLowInitialPlaylist: true,
                  smoothQualityChange: true,
                  overrideNative: sourceType === 'application/x-mpegURL',
                },
              },
            });

            console.log('Video.js player created:', window.currentPlayer);

            window.currentPlayer.src({
              src: proxyUrl,
              type: sourceType,
            });

            console.log('Source set:', proxyUrl, 'Type:', sourceType);

            window.currentPlayer.ready(() => {
              console.log('Video.js player ready with simple-proxy');
              console.log(
                'Player dimensions:',
                window.currentPlayer.videoWidth(),
                'x',
                window.currentPlayer.videoHeight(),
              );
              window.currentPlayer.play().catch((e) => {
                console.log('Autoplay prevented:', e);
                // Show play button overlay or message
                showError('Click the play button to start the video');
              });
            });

            window.currentPlayer.on('loadstart', () => {
              console.log('Video load started');
            });

            window.currentPlayer.on('loadedmetadata', () => {
              console.log('Video metadata loaded');
              console.log('Duration:', window.currentPlayer.duration());
              console.log(
                'Video dimensions:',
                window.currentPlayer.videoWidth(),
                'x',
                window.currentPlayer.videoHeight(),
              );
            });

            window.currentPlayer.on('canplay', () => {
              console.log('Video can start playing');
            });

            window.currentPlayer.on('playing', () => {
              console.log('Video is playing');
            });

            window.currentPlayer.on('error', (e) => {
              const error = window.currentPlayer.error();
              console.error('Simple-proxy player error:', error);
              console.error('Error details:', e);
              showError('Video playback failed. Stream may be unavailable or require special handling.');
            });
          } catch (error) {
            console.error('Error setting up simple-proxy stream:', error);
            showError('Failed to initialize video player: ' + error.message);
          }
        };

        // For HLS streams or streams requiring headers, use simple-proxy directly
        if (streamUrl.includes('.m3u8') || (headers && Object.keys(headers).length > 0)) {
          console.log('Stream requires proxy, using simple-proxy directly...');
          trySimpleProxy();
          return;
        }

        // Try direct URL first for simple streams
        const tryDirectStream = async () => {
          try {
            // Wait a bit to ensure DOM is ready
            await new Promise((resolve) => setTimeout(resolve, 100));

            // Check if there's already a player and dispose it properly
            const existingPlayer = videojs.getPlayer('videoPlayer');
            if (existingPlayer) {
              console.log('Disposing existing Video.js player for direct stream...');
              existingPlayer.dispose();
              await new Promise((resolve) => setTimeout(resolve, 100));
            }

            // Initialize Video.js player
            window.currentPlayer = videojs('videoPlayer', {
              fluid: true,
              responsive: true,
              controls: true,
              preload: 'auto',
              html5: {
                hls: {
                  enableLowInitialPlaylist: true,
                  smoothQualityChange: true,
                  overrideNative: sourceType === 'application/x-mpegURL',
                },
              },
            });

            // Try direct URL first
            window.currentPlayer.src({
              src: streamUrl,
              type: sourceType,
            });

            window.currentPlayer.ready(() => {
              console.log('Video.js player is ready');
              window.currentPlayer.play().catch((e) => {
                console.log('Autoplay prevented or failed:', e);
                // If direct fails, try with simple-proxy
                if (e.name === 'NotSupportedError' || e.message.includes('CORS')) {
                  console.log('Direct stream failed, trying with simple-proxy...');
                  trySimpleProxy();
                }
              });
            });

            window.currentPlayer.on('error', (e) => {
              const error = window.currentPlayer.error();
              console.error('Player error:', error);

              if (error && (error.code === 2 || error.code === 4 || error.message.includes('CORS'))) {
                console.log('CORS error detected, trying with simple-proxy...');
                trySimpleProxy();
              } else {
                showError('Video playback error: ' + (error?.message || 'Unknown error'));
              }
            });
          } catch (error) {
            console.error('Error setting up direct stream:', error);
            trySimpleProxy();
          }
        };

        // Start with direct stream
        tryDirectStream();
      }

      function showPlayer() {
        document.getElementById('videoPlayerSection').style.display = 'block';
        document.getElementById('videoPlayerSection').scrollIntoView({ behavior: 'smooth' });
      }

      function showLoading(type, show) {
        const loadingElement = document.getElementById(type + 'Loading');
        loadingElement.style.display = show ? 'flex' : 'none';
      }

      function showError(message) {
        const errorElement = document.getElementById('error');
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        setTimeout(() => {
          errorElement.style.display = 'none';
        }, 5000);
      }

      function hideError() {
        document.getElementById('error').style.display = 'none';
      }
    </script>
  </body>
</html>
